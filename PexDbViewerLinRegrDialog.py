"""Subclass of LinRegrDialog.py, which is generated by wxFormBuilder."""
from pandas.core.frame import DataFrame
import wx
import GeneratedGUI
from PersistClasses import *
from MultiReg import *

# Implementing LinRegrDialog.py
class PexDbViewerLinRegrDialog( GeneratedGUI.LinRegrDialog ):
	def __init__( self, parent, fact : sqp.SQFactory, proj : Project ):
		GeneratedGUI.LinRegrDialog.__init__(self, parent)
		self._f = fact
		self._p = proj
		self._floatpreci = 3
		self._forms = "{:." + str(self._floatpreci) + "f}" 
		self._float_factorpreci = 2
		self._factorforms = "{:." + str(self._float_factorpreci) + "f}" 
		self._currenttargabbr = None

	def LinRegrDialogOnInitDialog( self, event ):
		self.m_projectNameSTXT.SetLabelText(self._p.name)
		self._solver = MultiReg(self._f, self._p)
		self._solver.read_data()

		done = False
		for respabbr, response in self._solver.respdict.items():
			self.m_targetCHOI.Append(response.name, respabbr)
			done = True

		if done:
			self.m_targetCHOI.Select(0)

		self.m_factorPrecisionCHOI.Select(self._floatpreci)
		self.m_factorPrecisionCHOI.Select(self._float_factorpreci)

		self.m_summaryHTMLWIN.AppendToPage("Calculate to show summary here")
		
		
	def _get_floatstr(self, flnum):
		return self._forms.format(flnum)

	def show_input(self):
		df = self._solver.dataframe #already contains mean values in case of repetitions in the experiments
		
		if self.m_inputDataDLCTRL.GetColumnCount() <= 0: #we do this the first time, we have to add columns
			self.m_inputDataDLCTRL.AppendTextColumn("#",
				align=wx.ALIGN_RIGHT)
			for abbr, fact in self._solver.factdict.items():
				col = self.m_inputDataDLCTRL.AppendTextColumn(fact.name, 
					align=wx.ALIGN_RIGHT)

			for abbr, resp in self._solver.respdict.items():
				self.m_inputDataDLCTRL.AppendTextColumn(resp.name,
					align=wx.ALIGN_RIGHT)
		else: #we are just refreshing the data,we have do remove any existing rows
			self.m_inputDataDLCTRL.DeleteAllItems()
		
		drow = []
		ct = 0
		for idx, row in df.iterrows():
			drow.clear()
			ct += 1
			drow.append(str(ct))
			for abbr in self._solver.factdict:
				drow.append(self._get_floatstr(row[abbr]))

			for abbr in self._solver.respdict:
				drow.append(self._get_floatstr(row[abbr]))

			self.m_inputDataDLCTRL.AppendItem(drow)	

	def LinRegrDialogOnShow( self, event ):
		if event.Show is False:
			return

		self.show_input()
		
	def m_precisionCHOIOnChoice(self, event):
		choi = self.m_precisionCHOI.GetSelection()

		if choi == wx.NOT_FOUND:
			self._floatpreci = 3
		else:
			self._floatpreci = choi

		self._forms = "{:." + str(self._floatpreci) + "f}" 
		self.show_input()
		self.m_inputDataDLCTRL.Refresh()

	def _replaceabbr(self, txt : str):
		"""replace all abbreviations for factors and responses with their full names"""
		if txt is None: 
			return None

		answ = txt
		for key, resp in self._solver.respdict.items():
			answ = answ.replace(key, resp.name)
		for key, fact in self._solver.factdict.items():
			answ = answ.replace(key, fact.name)

		return answ

	def doCalcBUTOnButtonClick(self, event):
		targsel = self.m_targetCHOI.GetSelection()

		if targsel == wx.NOT_FOUND:
			return
		rabbr = self.m_targetCHOI.GetClientData(targsel)
		predi, sum = self._solver.solve_for(rabbr)

		self._currenttargabbr = rabbr

		self.m_summaryHTMLWIN.SetPage(self._replaceabbr(sum.as_html()))
		self._predi = predi
		self._sum = sum

	def m_linRegNBCKOnNotebookPageChanged(self, event):
		if event.Selection == 1: #we have changed to page 1
			self._initpredictpage()

	def _initpredictpage(self):
		if self._currenttargabbr is None:
			wx.MessageBox("Please execute a calculation first")

		self.m_targetResponseSTXT.SetLabelText(self._solver.respdict[self._currenttargabbr].name)
		self.m_formulaTBX.SetLabelText(self._solver.get_formula(self._factorforms))

		preds = self._solver.predict([0.2,95])

		print(preds)

	def m_factorPrecisionCHOIOnChoice(self, event):
		if event.Selection is not wx.NOT_FOUND:
			self._float_factorpreci = event.Selection
			self._factorforms = "{:." + str(event.Selection) + "f}"
			self.m_formulaTBX.SetLabelText(self._solver.get_formula(self._factorforms))
			
		